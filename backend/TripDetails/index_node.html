<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Trip Details</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
<style>
  body { background:#f7f8fa; }
  .card { border-radius: 16px; }
  .chip { display:inline-flex; align-items:center; gap:.35rem; background:#e9f2ff; border-radius:999px; padding:.4rem .7rem; margin:.2rem; font-size:.95rem }
  .chip .bi-x { cursor:pointer; }
  .sticky-footer { position: sticky; bottom:0; z-index:9; }
  .tap { min-height: 44px; }
  .table-responsive { overflow-x:auto; }
  .shadow-soft { box-shadow: 0 6px 24px rgba(0,0,0,.05); }
</style>
</head>
<body>
<div class="container py-3 py-md-4">

  <div class="d-flex align-items-center gap-2 mb-3">
    <i class="bi bi-truck fs-3 text-primary"></i>
    <h1 class="h4 m-0">Trip Details</h1>
  </div>

  <!-- Start Trip -->
  <div class="card shadow-soft mb-3">
    <div class="card-body">
      <div class="row g-3">

        <div class="col-12">
          <label class="form-label">Vehicle No <span class="text-danger">*</span></label>
          <select id="vehicle" class="form-select tap"></select>
        </div>

        <div class="col-12">
          <label class="form-label">Driver(s) <span class="text-danger">*</span></label>
          <div class="input-group">
            <select id="driverSelect" class="form-select tap"></select>
            <button id="addDriver" class="btn btn-outline-primary tap" type="button"><i class="bi bi-plus-lg"></i></button>
          </div>
          <div id="driverChips" class="mt-2"></div>
        </div>

        <div class="col-12">
          <label class="form-label">Helper (optional)</label>
          <select id="helper" class="form-select tap"></select>
        </div>

        <div class="col-12">
          <label class="form-label">Customer(s) <span class="text-danger">*</span></label>
          <div class="input-group">
            <input id="customerInput" class="form-control tap" list="custList" placeholder="Type name and press +"/>
            <datalist id="custList"></datalist>
            <button id="addCustomer" class="btn btn-outline-primary tap" type="button"><i class="bi bi-plus-lg"></i></button>
          </div>
          <div id="customerChips" class="mt-2"></div>
        </div>

        <div class="col-6">
          <label class="form-label">Trip Start Date <span class="text-danger">*</span></label>
          <input id="startDate" type="text" class="form-control tap" placeholder="dd-mm-yyyy"/>
        </div>

        <div class="col-6">
          <label class="form-label">Trip Starting KM <span class="text-danger">*</span></label>
          <input id="startKm" type="number" class="form-control tap" min="0" inputmode="numeric" placeholder="e.g. 12345"/>
        </div>

        <div class="col-12">
          <label class="form-label">Note</label>
          <textarea id="note" class="form-control tap" rows="2" placeholder="Any note..."></textarea>
        </div>

        <div class="col-12 d-grid">
          <button id="startTripBtn" class="btn btn-primary btn-lg tap">Start Trip (Ongoing)</button>
        </div>

      </div>
    </div>
  </div>

  <!-- End Trip (modal) -->
  <div class="modal fade" id="endTripModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">End Trip</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body row g-3">
          <input type="hidden" id="endTripId"/>
          <div class="col-6">
            <label class="form-label">Trip End Date</label>
            <input id="endDate" type="text" class="form-control tap" placeholder="dd-mm-yyyy"/>
          </div>
          <div class="col-6">
            <label class="form-label">Trip End KM</label>
            <input id="endKm" type="number" class="form-control tap" min="0" inputmode="numeric" placeholder="e.g. 14567"/>
          </div>
          <div class="col-12">
            <div class="form-text" id="computedRun"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="saveEndTrip" class="btn btn-success">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Trips list -->
  <div class="card shadow-soft">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
        <h2 class="h5 m-0">Trips (Latest First)</h2>
        <small class="text-muted" id="vehLabel"></small>
      </div>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th>Start</th>
              <th>Drivers</th>
              <th>Helper</th>
              <th>Customers</th>
              <th>Status</th>
              <th>End</th>
              <th class="text-end">Run KM</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody id="tripRows"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const state = {
  drivers: [], helpers: [], vehicles: [], customers: [],
  chosenDrivers: [], customerTags: []
};

const fmtToISO = (ddmmyyyy) => {
  const [dd, mm, yyyy] = ddmmyyyy.split('-').map(Number);
  if (!dd || !mm || !yyyy) return null;
  return `${yyyy}-${String(mm).padStart(2,'0')}-${String(dd).padStart(2,'0')}`;
};
const todayDDMMYYYY = () => {
  const d=new Date();
  const dd=String(d.getDate()).padStart(2,'0');
  const mm=String(d.getMonth()+1).padStart(2,'0');
  const yyyy=d.getFullYear();
  return `${dd}-${mm}-${yyyy}`;
};

async function loadMeta() {
  const res = await fetch('/api/meta');
  const data = await res.json();
  state.drivers = data.drivers || [];
  state.helpers = data.helpers || [];
  state.vehicles = data.vehicles || [];
  state.customers = data.customers || [];

  // fill selects
  const vehicleSel = document.getElementById('vehicle');
  vehicleSel.innerHTML = `<option value="">Select Vehicle</option>` + state.vehicles.map(v=>`<option value="${v.id}">${v.vehicle_no}</option>`).join('');

  const driverSel = document.getElementById('driverSelect');
  driverSel.innerHTML = state.drivers.map(d=>`<option value="${d.id}">${d.name}</option>`).join('');

  const helperSel = document.getElementById('helper');
  helperSel.innerHTML = `<option value="">No Helper</option>` + state.helpers.map(h=>`<option value="${h.id}">${h.name}</option>`).join('');

  const dl = document.getElementById('custList');
  dl.innerHTML = state.customers.map(c=>`<option value="${c.name}">`).join('');

  // Default date
  document.getElementById('startDate').value = todayDDMMYYYY();
}

function renderDriverChips() {
  const wrap = document.getElementById('driverChips');
  wrap.innerHTML = '';
  state.chosenDrivers.forEach(id => {
    const d = state.drivers.find(x=>x.id==id);
    if (!d) return;
    const chip = document.createElement('span');
    chip.className = 'chip';
    chip.innerHTML = `<span>${d.name}</span><i class="bi bi-x" data-id="${id}"></i>`;
    chip.querySelector('i').onclick = () => {
      state.chosenDrivers = state.chosenDrivers.filter(x=>x!=id);
      renderDriverChips();
    };
    wrap.appendChild(chip);
  });
}
function renderCustomerChips() {
  const wrap = document.getElementById('customerChips');
  wrap.innerHTML = '';
  state.customerTags.forEach(name => {
    const chip = document.createElement('span');
    chip.className = 'chip';
    chip.innerHTML = `<span>${name}</span><i class="bi bi-x" data-name="${name}"></i>`;
    chip.querySelector('i').onclick = () => {
      state.customerTags = state.customerTags.filter(x=>x!==name);
      renderCustomerChips();
    };
    wrap.appendChild(chip);
  });
}

document.getElementById('addDriver').onclick = () => {
  const sel = document.getElementById('driverSelect');
  const id = sel.value;
  if (id && !state.chosenDrivers.includes(id)) {
    state.chosenDrivers.push(id);
    renderDriverChips();
  }
};
document.getElementById('addCustomer').onclick = () => {
  const inp = document.getElementById('customerInput');
  const name = (inp.value || '').trim();
  if (name && !state.customerTags.includes(name)) {
    state.customerTags.push(name);
    renderCustomerChips();
    inp.value = '';
  }
};

document.getElementById('vehicle').onchange = () => {
  const opt = document.getElementById('vehicle').selectedOptions[0];
  document.getElementById('vehLabel').textContent = opt && opt.value ? `Vehicle: ${opt.textContent}` : '';
  loadTrips();
};

document.getElementById('startTripBtn').onclick = async () => {
  const vehicle_id = document.getElementById('vehicle').value;
  const start_date = fmtToISO(document.getElementById('startDate').value);
  const start_km = document.getElementById('startKm').value;
  const helper_id = document.getElementById('helper').value || null;
  const note = document.getElementById('note').value || null;

  if (!vehicle_id) return alert('Select vehicle');
  if (!start_date) return alert('Enter start date (dd-mm-yyyy)');
  if (!start_km) return alert('Enter starting KM');
  if (state.chosenDrivers.length === 0) return alert('Add at least one driver');
  if (state.customerTags.length === 0) return alert('Add at least one customer');

  const body = {
    vehicle_id, start_date, start_km: Number(start_km),
    driver_ids: state.chosenDrivers.map(Number),
    helper_id: helper_id ? Number(helper_id) : null,
    customer_names: state.customerTags,
    note
  };

  const res = await fetch('/api/trips', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  const data = await res.json();
  if (!res.ok) return alert(data.error || 'Failed to start trip');

  // reset form but keep selected vehicle
  state.chosenDrivers = [];
  state.customerTags = [];
  renderDriverChips();
  renderCustomerChips();
  document.getElementById('startKm').value = '';
  document.getElementById('note').value = '';
  document.getElementById('startDate').value = todayDDMMYYYY();

  await loadTrips();
  alert('Trip started (Ongoing).');
};

async function loadTrips() {
  const vehicle_id = document.getElementById('vehicle').value;
  const tbody = document.getElementById('tripRows');
  tbody.innerHTML = '';
  if (!vehicle_id) return;

  const res = await fetch(`/api/trips?vehicle_id=${vehicle_id}`);
  const rows = await res.json();

  for (const r of rows) {
    const tr = document.createElement('tr');

    tr.innerHTML = `
      <td>
        <div class="small text-muted">${r.start_date_fmt || ''}</div>
        <div class="small">KM: ${r.start_km ?? ''}</div>
      </td>
      <td><div class="small">${r.drivers || '-'}</div></td>
      <td><div class="small">${r.helper || '-'}</div></td>
      <td><div class="small">${r.customers || '-'}</div></td>
      <td>
        ${r.status === 'ongoing' 
          ? '<span class="badge bg-warning text-dark">Ongoing</span>'
          : '<span class="badge bg-success">Ended</span>'}
      </td>
      <td>
        <div class="small text-muted">${r.end_date_fmt || ''}</div>
        <div class="small">${r.end_km ? ('KM: '+r.end_km) : ''}</div>
      </td>
      <td class="text-end fw-semibold">${r.total_km ?? '-'}</td>
      <td class="text-end">
        ${r.status === 'ongoing' 
          ? `<button class="btn btn-sm btn-outline-success me-1 endTripBtn" data-id="${r.id}" data-startkm="${r.start_km}">
               End
             </button>` 
          : ''}
        <button class="btn btn-sm btn-outline-danger delBtn" data-id="${r.id}">
          Delete
        </button>
      </td>
    `;

    tbody.appendChild(tr);
  }

  // wire buttons
  document.querySelectorAll('.endTripBtn').forEach(btn => {
    btn.onclick = () => openEndModal(btn.dataset.id, btn.dataset.startkm);
  });
  document.querySelectorAll('.delBtn').forEach(btn => {
    btn.onclick = () => deleteTrip(btn.dataset.id);
  });
}

function openEndModal(tripId, startKm) {
  document.getElementById('endTripId').value = tripId;
  document.getElementById('endDate').value = todayDDMMYYYY();
  document.getElementById('endKm').value = '';
  document.getElementById('computedRun').textContent = `Start KM: ${startKm}`;
  const modal = new bootstrap.Modal(document.getElementById('endTripModal'));
  modal.show();

  const endKmInp = document.getElementById('endKm');
  endKmInp.oninput = () => {
    const ek = Number(endKmInp.value || 0);
    const run = ek - Number(startKm);
    document.getElementById('computedRun').textContent = run >= 0
      ? `Start KM: ${startKm} → End KM: ${ek} → Total: ${run} KM`
      : `End KM must be ≥ Start KM (${startKm})`;
  };
}

document.getElementById('saveEndTrip').onclick = async () => {
  const id = document.getElementById('endTripId').value;
  const end_date = fmtToISO(document.getElementById('endDate').value);
  const end_km = document.getElementById('endKm').value;
  if (!end_date) return alert('Enter end date (dd-mm-yyyy)');
  if (!end_km) return alert('Enter end KM');

  const res = await fetch(`/api/trips/${id}/end`, {
    method:'PATCH',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ end_date, end_km: Number(end_km) })
  });
  const data = await res.json();
  if (!res.ok) return alert(data.error || 'Failed to end trip');

  bootstrap.Modal.getInstance(document.getElementById('endTripModal')).hide();
  await loadTrips();
};

async function deleteTrip(id) {
  if (!confirm('Delete this trip?')) return;
  const res = await fetch(`/api/trips/${id}`, { method:'DELETE' });
  const data = await res.json();
  if (!res.ok) return alert(data.error || 'Failed to delete trip');
  await loadTrips();
}

// init
loadMeta();
</script>
</body>
</html>